---
import classes from './Link.module.css';
import { resolveId } from '../lib/posts.ts';
import { bibliography } from '../lib/bibliography.js';

const { class: class_, className, href, ...props } = Astro.props;

let broken = false;
let link = href;
const url = new URL(link, 'file://');
if (url.protocol === 'id:' || url.protocol === 'cite:') {
  try {
    link = await resolveId(link);
  } catch {
    broken = true;
  }
}

const external =
  url.hostname !== 'oleksii.shmalko.com' &&
  (url.protocol === 'http:' ||
    url.protocol === 'https:' ||
    url.protocol === 'mailto:');

const rel = [props.rel, external ? 'noopener' : ''].join(' ');
---

<a
  rel={rel}
  target={external ? '_blank' : undefined}
  preload={!external}
  role={broken ? 'link' : undefined}
  aria-disabled={broken}
  {...props}
  href={broken ? undefined : link}
  class:list={[classes.link, { external, broken }, class_, className]}
  ><slot /></a
>
